<!doctype html>
<html lang="en">
<head>
  <!-- font awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <title>Dashboard</title>
</head>
<body class="">
<!-- load navbar -->
<script src="../static/navbar.js"></script>

<form>
<table class="table table-hover">
  <thead class="thead-light">
    <tr>
      <th scope="col">Row</th>
      <th scope="col">Name</th>
      <th scope="col">Amount</th>
      <th scope="col">Days Left</th>
      <th scope="col">Due Date</th>
    </tr>
  </thead>

  <tbody id="table-rows">

  </tbody>
</table>
</form>

<script src="../static/main.js"></script>
<script>
  let isInEditMode = false;
  async function getJson(url)
  {
    let response = await fetch(url);
    let data = await response.json();
    return data;
  }



  async function main()
  {

    jdata = await getJson("http://127.0.0.1:5000/bill");
    for (let i = 0; i < jdata.length; i++)
    {
      let bill = jdata[i]
      document.getElementById("table-rows").innerHTML +=
              `<tr id="${i}"><th scope="row"><text>${i}</text></th>` +
              `<td ><text id="name${i}" class="editField${i}"> ${bill.name} </text> </td>` +
              `<td ><text id="amount${i}" class="editField${i}">${bill.amount}</text> </td>` +
              `<td> Calculate days left here</td>` +
              `<td ><text id="due_date${i}" class="editField${i}">${bill.due_date}</text></td>` +
              `<td><button id="${i}" onclick="clickedEditButton(this.id, jdata)" type="button" class="btn btn-outline-secondary btn${i}"> <i class="fa fa-pencil-square-o" aria-hidden="true"></i></button></td></tr>`



    }
  }
  main();

  function clickedEditButton(id,jdata)
  {
    if (isInEditMode)
    {
      return alert("already in edit mode");
    }
    isInEditMode = true;

    const rowId = id;

    // get corresponding bill object
    let bill = jdata[rowId];

    // get the row by using rowId
    const row = document.getElementById(rowId);


    // get all elements that allow editing by user
    let editFields = document.getElementsByClassName("editField" + rowId);

    // convert text fields into input fields
    replaceElementsWithNewElements(editFields, createInputElementsFromTextElements(editFields, rowId));

    //Add check button next to edit button
    let editBtn = document.getElementsByClassName("btn"+rowId)[0]; // get the edit button for the row being edited

    // create save edit button
    let saveEdit = document.createElement("button");
    let checkMarkIcon = document.createElement("i");

    checkMarkIcon.setAttribute("class", "fa fa-check");


    saveEdit.setAttribute("class", editBtn.getAttribute("class") + "btn btn-success");
    //saveEdit.setAttribute("type", "submit");
    //saveEdit.setAttribute("form", "form"+ rowId);
    saveEdit.setAttribute("id", rowId);
    //saveEdit.setAttribute("type", "submit");
    saveEdit.appendChild(checkMarkIcon);

    editBtn.replaceWith(saveEdit);
    saveEdit.addEventListener("click", serializeFormJson);

    //create uuid parameter for our button function so we can access the uuid later
    saveEdit.UUID = jdata[rowId]['id'];


  }
  function createInputElementsFromTextElements(fields, rowId)
  {
    let inputElements = [];
    for (let i =0; i < fields.length; i++)
    {
      let currentTextField = fields[i];

      let input = document.createElement("input");

      input.setAttribute("id", currentTextField.id);

      if (currentTextField.id.includes("amount"))
      {
        input.setAttribute("type","number");
        input.setAttribute("min","0");
      }
      input.setAttribute("placeholder", currentTextField.innerHTML);


      //currentTextField.replaceWith(input);
      input.setAttribute("class", currentTextField.getAttribute("class"));
      inputElements.push(input);

    }
    return inputElements;
  }

  function replaceElementsWithNewElements(oldElements, newElements)
  {
    const oldElementsLen = oldElements.length;

    for (let i =0; i< oldElements.length; i++)
    {
      oldElements[i].replaceWith(newElements[i]);
      console.log("old elements len:" + oldElements.length +"  newElements len: "+ newElements.length);

    }
  }

  function serializeFormJson(event)
  {
    event.preventDefault();
    let jdata = {}
    let rowId = event.currentTarget.id;
    let row = document.getElementById(rowId);
    let inputElements = row.getElementsByClassName("editField"+ rowId);


    for(let i =0; i< inputElements.length; i++)
    {
      let currentElement = inputElements[i];

      // remove UID from the element id i.e name0 -> name
      let key = currentElement.getAttribute("id").replace(/[0-9]/g, '');
      let defaultValue = currentElement.getAttribute("placeholder");
      let value = currentElement.value;

      //TODO this is temporary, need to add due day in backend
      if (key == "due_date")
      {
       value = "6";
      }
      if (value == "")
      {
        // if user entered no data, set json value to existing value
        value = defaultValue;
      }
      jdata[key] = value;
    }
    console.log(jdata);
    const requestOptions = {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body:JSON.stringify(jdata)
    };
    fetch('http://127.0.0.1:5000/bill/' + event.currentTarget.UUID, requestOptions)
            .then(response => response.json())
            .then(data => console.log(data));

    // reload page
    location.reload();

  }
  function submitEditToApi(event)
  {
  jdata = serializeFormJson(event);
  }
</script>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>

