<!doctype html>
<html lang="en">
<head>
  <!-- font awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <title>Dashboard</title>
</head>
<body class="">
<!-- load navbar -->
<script src="../static/navbar.js"></script>


<table class="table table-hover">
  <thead class="thead-light">
    <tr>
      <th scope="col">Name</th>
      <th scope="col">Amount</th>
      <th scope="col">Days Left</th>
      <th scope="col">Due Date</th>
    </tr>
  </thead>
  <tbody id="table-rows">

  </tbody>

</table>


<script src="../static/main.js"></script>
<script>
  // .then will return the results into the next .then
  async function getJson(url)
  {
    let response = await fetch(url);
    let data = await response.json();
    return data;
  }



  async function main()
  {

    jdata = await getJson("http://127.0.0.1:5000/bill");
    for (let i = 0; i < jdata.length; i++)
    {
      let bill = jdata[i]
      document.getElementById("table-rows").innerHTML +=
              `<form id="form${i}"><tr id="${i}"><th scope="row"><text id="name${i}" class="editField${i}">${bill.name}</text></th>` +
              `<td ><text id="amount${i}" class="editField${i}">${bill.amount}</text> </td>` +
              `<td> Calculate days left here</td>` +
              `<td ><text id="date${i}" class="editField${i}">${bill.due_date}</text></td>` +
              `<i id="${bill.id}"></i>` +
              `<td><button id="${i}" onclick="clickedEditButton(this.id, jdata)" type="button" class="btn btn-outline-secondary btn${i}"> <i class="fa fa-pencil-square-o" aria-hidden="true"></i></button></td></tr> </form>`



    }
  }
  main();

  function clickedEditButton(id,jdata)
  {
    const rowId = id;

    // get corresponding bill object
    let bill = jdata[rowId];

    // get the row by using rowId
    const row = document.getElementById(rowId);


    // get all elements that allow editing by user
    let editFields = document.getElementsByClassName("editField" + rowId);

    console.log(editFields);
    // convert text fields into input fields
    replaceElementsWithNewElements(editFields, createInputElementsFromTextElements(editFields));

    //Add check button next to edit button
    let editBtn = document.getElementsByClassName("btn"+rowId)[0]; // get the edit button for the row being edited

    // create save edit button
    let saveEdit = document.createElement("button");
    let checkMarkIcon = document.createElement("i");

    checkMarkIcon.setAttribute("class", "fa fa-check");


    saveEdit.setAttribute("class", editBtn.getAttribute("class"));
    //saveEdit.setAttribute("type", "submit");
    //saveEdit.setAttribute("form", "form"+ rowId);
    saveEdit.setAttribute("id", rowId);

    saveEdit.appendChild(checkMarkIcon);

    editBtn.replaceWith(saveEdit);
    saveEdit.addEventListener("click", serializeFormJson, false);



  }
  function createInputElementsFromTextElements(fields)
  {
    let inputElements = [];
    for (let i =0; i < fields.length; i++)
    {
      let currentTextField = fields[i];

      let input = document.createElement("input");

      input.setAttribute("id", currentTextField.id);
      if (currentTextField.id.includes("amount"))
      {
        //TODO cannot figure out why form validation is not working, may need to write my own :/
        input.setAttribute("type","number");
        input.setAttribute("min","1");
      }
      input.setAttribute("placeholder", currentTextField.innerHTML);


      //currentTextField.replaceWith(input);
      inputElements.push(input);

    }
    return inputElements;
  }

  function replaceElementsWithNewElements(oldElements, newElements)
  {
    const oldElementsLen = oldElements.length;
    // swap all old elements with new ones
    while (newElements.length >0){
      oldElements[0].replaceWith(newElements[0]);
      newElements.shift();
    }
  }

  function serializeFormJson(event, id)
  {
    console.log(document.getElementById(event.currentTarget.id));


  }
  let button = document.getElementById("submit");
</script>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>

